<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Hello World Glia</title>
</head>
<body>

  <div id="signup-container">
    <input type="email" id="email" placeholder="Enter your email" required>
    <button type="button" id="submit">Submit</button>
  </div>
  <script>
		//Read idtoken from query parameter with the same name.
		const params = new Proxy(new URLSearchParams(window.location.search), {
			get: (searchParams, prop) => searchParams.get(prop),
		});
		const idToken = params.idtoken;
		window.getGliaContext = () => ({ idToken });
	</script>

  <script src="//api.beta.glia.com/salemove_integration.js"></script>

  <script>
    sm.getApi({version: 'v1'}).then(function(glia) {
      // --- 1. Detect Geo-Location and Set Custom Attribute ---
      fetch('https://ipapi.co/json/')
        .then(response => response.json())
        .then(data => {
          const countryCode = data.country_code; // e.g., "EE", "US", "DE"
          const locationValue = (countryCode === 'EE') ? 'EE' : 'other';

          // Update Visitor Information in Glia
          glia.updateInformation({
            customAttributesUpdateMethod: 'merge',
            customAttributes: {
              location: locationValue
            }
          }).then(function() {
            console.log('Glia attribute set: location =', locationValue);
          });
        })
        .catch(err => console.error('Error fetching location:', err));

      // --- 2. Signup Form Listener ---
      
      function addSubmitListener(engagement) {
        var submit = document.querySelector('#submit');
        var emailInput = document.querySelector('#email');

        if (submit) {
          submit.addEventListener('click', function() {
            var email = emailInput.value;
            // Record the event in the Glia engagement timeline
            engagement.recordEvent({
              message: 'Visitor signed up with e-mail: ' + email
            });
            console.log('Event recorded for:', email);
          });
        }
      }

      // Listen for the start of an engagement to attach the listener
      glia.addEventListener(glia.EVENTS.ENGAGEMENT_START, addSubmitListener);
    });
  </script>

</body>
</html>